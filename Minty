#!/bin/bash

# Check if the script is being run as root
if [ "$(id -u)" != "0" ]; then
   echo "This script must be run as root."
   exit 1
fi

echo "this script is for mint only run on mint linux or it might brick it; press Ctrl+C to cancel."
sleep 5  # Pauses for 5 seconds
echo "Continuing script..."

# Enable the firewall (UFW)
echo "Enabling UFW firewall..."
apt install -y ufw
ufw default deny incoming
ufw default allow outgoing
ufw allow ssh
ufw enable
apt-get install -y ufw
ufw --force reset
ufw default deny incoming
ufw default allow outgoing
ufw allow OpenSSH
ufw limit OpenSSH
ufw --force enable
ufw status verbose



# Install and configure Fail2Ban
echo "Installing and configuring Fail2Ban..."
apt install -y fail2ban
systemctl enable fail2ban
systemctl start fail2ban

# Set minimum/maximum password age
backup_file /etc/login.defs
sed -i '/^PASS_MIN_DAYS/d' /etc/login.defs && echo "PASS_MIN_DAYS   7" >> /etc/login.defs
sed -i '/^PASS_MAX_DAYS/d' /etc/login.defs && echo "PASS_MAX_DAYS   90" >> /etc/login.defs

# Enforce pam_pwquality complexity
apt-get install -y libpam-pwquality
backup_file /etc/pam.d/common-password
sed -ri '/pam_pwquality.so/ d' /etc/pam.d/common-password
echo 'password requisite pam_pwquality.so retry=3 minlen=14 ucredit=-1 lcredit=-1 dcredit=-1 ocredit=-1 enforce_for_root' >> /etc/pam.d/common-password

# Ensure shadow is root:shadow 640
chown root:shadow /etc/shadow
chmod 0640 /etc/shadow

# Ensure passwd group readable but not writable
chown root:root /etc/passwd
chmod 0644 /etc/passwd

# Secure group file
chown root:root /etc/group
chmod 0644 /etc/group

backup_file /etc/sysctl.d/60-stig.conf
cat > /etc/sysctl.d/60-stig.conf <<'EOF'
net.ipv4.ip_forward = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.tcp_syncookies = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv6.conf.all.accept_ra = 0
EOF
sysctl --system || true

# Set home dirs to 750 for real users (UID >=1000)
awk -F: '($3 >= 1000 && $1 != "nobody") {print $1":"$6}' /etc/passwd | while IFS=: read -r user home; do [ -d "$home" ] && chmod 0750 "$home"; done



